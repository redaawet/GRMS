{% extends "admin/base_site.html" %}
{% load static %}

{% block bodyclass %}grms-dashboard-page {{ block.super }}{% endblock %}

{% block grms_main_content %}
<div class="grms-dashboard">
    <header class="grms-hero">
        <p class="hero-kicker">Gravel Road Management System</p>
        <h1 class="dash-title">GRMS Dashboard</h1>
        <p class="dash-subtitle">Quick analytics and shortcuts for the admin team.</p>
    </header>

    <section class="dashboard-grid" aria-label="Dashboard overview">
        <article class="kpi-card">
            <p class="kpi-label">Total Roads</p>
            <p class="kpi-value">{{ total_roads }}</p>
        </article>
        <article class="kpi-card">
            <p class="kpi-label">Sections</p>
            <p class="kpi-value">{{ total_sections }}</p>
        </article>
        <article class="kpi-card">
            <p class="kpi-label">Segments</p>
            <p class="kpi-value">{{ total_segments }}</p>
        </article>

        <article class="dash-card">
            <h3>Planned Interventions</h3>
            <p class="dashboard-card-value">{{ planned_interventions }}</p>
            <p class="panel-subtitle">Projects in the current pipeline</p>
        </article>

        <article class="dash-card">
            <h3>Latest Traffic Year</h3>
            <p class="dashboard-card-value">{{ latest_traffic_year|default:"â€“" }}</p>
            <p class="panel-subtitle">Most recent ADT survey</p>
        </article>

        <article class="dash-card span-2">
            <div class="panel-heading">
                <h2>Surface Type Distribution</h2>
                <p class="panel-subtitle">Share of asphalt, gravel, and dirt surfaces</p>
            </div>
            <canvas id="surfaceChart" aria-label="Surface distribution chart"></canvas>
        </article>

        <article class="dash-card span-2">
            <div class="panel-heading">
                <h2>Traffic Trend (ADT)</h2>
                <p class="panel-subtitle">Recent average daily traffic readings</p>
            </div>
            <canvas id="trafficChart" aria-label="Traffic trend chart"></canvas>
        </article>

        <article class="dash-card span-3 map-card">
            <div class="panel-heading">
                <h2>Road Network Overview</h2>
                <p class="panel-subtitle">Mapped road locations from the latest data</p>
            </div>
            <div id="roadMap" aria-label="Road map"></div>
        </article>

        {% if sections %}
        <article class="dash-card span-3">
            <div class="panel-heading">
                <h2>Admin shortcuts</h2>
                <p class="panel-subtitle">Manage grouped models without leaving the dashboard.</p>
            </div>
            <div class="section-grid">
                {% for section in sections %}
                <article class="section-card">
                    <div class="section-card__header">
                        <h3>{{ section.title }}</h3>
                        <p class="section-card__hint">{{ section.models|length }} models</p>
                    </div>
                    <ul class="section-card__links">
                        {% for model in section.models %}
                            <li>
                                <a href="{{ model.admin_url }}">{{ model.name }}</a>
                                {% if model.add_url %}
                                <a class="section-card__add" href="{{ model.add_url }}">Add</a>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </article>
                {% endfor %}
            </div>
        </article>
        {% endif %}
    </section>
</div>

{{ grms_data|json_script:"grms-data" }}
{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'grms/css/dashboard.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (!window.Chart) return;

      const surfaceCtx = document.getElementById('surfaceChart');
      if (surfaceCtx) {
        new Chart(surfaceCtx, {
          type: 'pie',
          data: {
            labels: ['Gravel', 'Paved'],
            datasets: [{ data: {{ surface_distribution|safe }} }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
      }

      const conditionCtx = document.getElementById('conditionChart');
      if (conditionCtx) {
        new Chart(conditionCtx, {
          type: 'pie',
          data: {
            labels: ['Good', 'Fair', 'Poor', 'Bad'],
            datasets: [{ data: {{ condition_distribution|safe }} }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
      }

      const trafficCtx = document.getElementById('trafficChart');
      if (trafficCtx) {
        new Chart(trafficCtx, {
          type: 'line',
          data: {
            labels: {{ traffic_labels|safe }},
            datasets: [{
              label: 'ADT',
              data: {{ traffic_data|safe }},
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37, 99, 235, 0.12)',
              fill: true,
              tension: 0.3,
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }

      const zoneCtx = document.getElementById('zoneLengthChart');
      if (zoneCtx) {
        new Chart(zoneCtx, {
          type: 'bar',
          data: {
            labels: {{ zone_labels|safe }},
            datasets: [{
              label: 'Total KM',
              data: {{ zone_lengths|safe }},
              backgroundColor: '#4e79a7'
            }]
          },
          options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        });
      }

      const priorityCtx = document.getElementById('priorityChart');
      if (priorityCtx) {
        new Chart(priorityCtx, {
          type: 'bar',
          data: {
            labels: ['High', 'Medium', 'Low'],
            datasets: [{
              data: {{ priority_counts|safe }},
              backgroundColor: ['#d62728', '#ffbf00', '#2ca02c']
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }

      const mciCtx = document.getElementById('mciChart');
      if (mciCtx) {
        new Chart(mciCtx, {
          type: 'bar',
          data: {
            labels: {{ mci_bins|safe }},
            datasets: [{
              label: 'Road Count',
              data: {{ mci_counts|safe }},
              backgroundColor: '#f28e2b'
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    });
  </script>
{% endblock %}
