{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    {% if map_admin_config %}
        {{ map_admin_config|json_script:"map-admin-config" }}
    {% endif %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js"></script>
    <script src="{% static 'grms/js/mapPreview.js' %}"></script>
    <link rel="stylesheet" href="{% static 'grms/css/road-admin.css' %}">
    <script src="{% static 'grms/js/map-admin.js' %}" defer></script>
{% endblock %}

{% block after_field_sets %}
    {{ block.super }}
    <div id="map-panel"
         class="road-map-panel {% if not map_admin_config %}road-map-panel--disabled{% endif %}"
        data-map-scope="{{ map_admin_config.scope|default_if_none:'' }}"
        data-map-context-url="{{ map_admin_config.api.map_context|default_if_none:'' }}">
        <div class="road-map-panel__info">
            <h3>Map preview</h3>
            {% if map_admin_config and map_admin_config.section %}
                {% if map_admin_config.section.start_chainage_km and map_admin_config.section.end_chainage_km %}
                    <p class="help">
                        Preview uses your start and end alignment between
                        <strong>{{ map_admin_config.section.start_chainage_km|floatformat:"3" }}</strong> km and
                        <strong>{{ map_admin_config.section.end_chainage_km|floatformat:"3" }}</strong> km.
                    </p>
                    {% if map_admin_config.section.points.start and map_admin_config.section.points.end %}
                        <p class="help">
                            Start coordinates: {{ map_admin_config.section.points.start.lat|floatformat:"6" }}, {{ map_admin_config.section.points.start.lng|floatformat:"6" }}{% if map_admin_config.section.points.start.easting %} ({{ map_admin_config.section.points.start.easting|floatformat:"2" }} E / {{ map_admin_config.section.points.start.northing|floatformat:"2" }} N){% endif %}
                            <br>End coordinates: {{ map_admin_config.section.points.end.lat|floatformat:"6" }}, {{ map_admin_config.section.points.end.lng|floatformat:"6" }}{% if map_admin_config.section.points.end.easting %} ({{ map_admin_config.section.points.end.easting|floatformat:"2" }} E / {{ map_admin_config.section.points.end.northing|floatformat:"2" }} N){% endif %}
                        </p>
                    {% else %}
                        <p class="help">Enter both start and end coordinates to render the preview.</p>
                    {% endif %}
                {% else %}
                    <p class="help">Provide start/end chainage plus both alignment coordinates to enable the preview.</p>
                {% endif %}
            {% else %}
                <p class="help">Save the section first to enable the map preview.</p>
            {% endif %}
            <p class="help">Highlights the section extents alongside admin boundaries, towns, and optional base layers.</p>
            <p class="help">Keep chainage, sequence order, and alignment coordinates in sync for a clean validation report.</p>
        </div>
        <div class="road-map-panel__viewport" id="map-panel-viewport">
            <div class="road-map-panel__placeholder">
                <h3>Section map preview</h3>
                <p>
                    {% if map_admin_config %}
                        Use the refresh button to load the parent road and highlight this section on the map.
                    {% else %}
                        Save the section first to enable the map preview.
                    {% endif %}
                </p>
            </div>
        </div>
        <div class="road-map-panel__status" id="map-panel-status"></div>
        {% if map_admin_config %}
            <div class="road-map-panel__actions">
                <div class="road-map-panel__selectors">
                    <label><input type="radio" name="section-marker" value="start" checked> Set start</label>
                    <label><input type="radio" name="section-marker" value="end"> Set end</label>
                    <button type="button" class="button" id="map-panel-refresh">Refresh map</button>
                </div>
                <p class="help">Click the map to set the active marker; latitude/longitude are copied into the form.</p>
                <p class="help">The blue highlight represents this section along the parent road.</p>
            </div>
        {% endif %}
    </div>
{% endblock %}
